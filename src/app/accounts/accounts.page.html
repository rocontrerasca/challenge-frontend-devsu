<div class="card">
  <h2>Cuentas</h2>

  <!-- Selector de Cliente + Búsqueda local -->
  <div class="row" style="gap:12px; margin-bottom: 10px;">
    <div style="min-width:260px; flex:1;">
      <label style="font-weight:600; display:block; margin-bottom:6px;">Cliente</label>
      <select class="input" [disabled]="editMode()" [value]="form.getRawValue().clientRefId"
        (change)="onClientChange(($any($event.target).value))">
        <option value="" disabled>Seleccione un cliente</option>
        <option *ngFor="let c of clients()" [value]="c.clientId">{{ c.fullName }}</option>
      </select>
    </div>
  </div>

  <!-- Formulario create/update -->
  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="form">
    <div class="field field--4">
      <label>Número de cuenta</label>
      <input class="input" formControlName="accountNumber" placeholder="" />
      <div class="help" *ngIf="submitted && form.controls.accountNumber.invalid">
        Requerido
      </div>
    </div>

    <div class="field field--4">
      <label>Tipo</label>
      <select class="input" formControlName="accountType">
        <option [ngValue]="1">Ahorros</option>
        <option [ngValue]="2">Corriente</option>
      </select>
    </div>

    <div class="field field--4">
      <label>Saldo inicial</label>
      <input class="input" type="number" min="0" step="0.01" formControlName="initialBalance" />
      <div class="help" *ngIf="submitted && form.controls.initialBalance.invalid">
        Requerido
      </div>
    </div>

    <div class="field field--3">
      <label>Estado</label>
      <select class="input" formControlName="active">
        <option [ngValue]="true">Activa</option>
        <option [ngValue]="false">Inactiva</option>
      </select>
    </div>

    <div class="row-nowrap" style="margin-top:8px;">
      <button class="btn nowrap" type="submit">{{ editMode() ? 'Actualizar' : 'Crear' }}</button>
      <button class="btn secondary nowrap" type="button"
        (click)="editMode() ? cancelEdit() : form.reset({ clientRefId: form.value.clientRefId ?? '', accountNumber:'', accountType:1, initialBalance:0, active:true }); submitted=false">
        {{ editMode() ? 'Cancelar' : 'Limpiar' }}
      </button>
      <span class="spacer"></span>
      <span class="muted" *ngIf="loading()">Procesando…</span>
    </div>
  </form>
</div>

<div class="card">
  <div class="row" style="justify-content: space-between; align-items:center;">
    <h3 style="margin:0;">Listado de cuentas</h3>
    <input #q class="input" style="max-width:320px" type="search"
      placeholder="Buscar por cliente, número cuenta" [value]="searchTerm()" (input)="onSearchInput(q.value)"
      (keyup.enter)="onSearchInput(q.value)" />
    <button class="btn secondary" (click)="refreshList()" [disabled]="loading()">Refrescar</button>
  </div>
  <br />
  <div class="table-wrap" *ngIf="filtered().length; else emptyState">
    <table class="table">
      <thead>
        <tr>
          <th>Número</th>
          <th>Tipo</th>
          <th>Saldo inicial</th>
          <th>Estado</th>
          <th>Cliente</th>
          <th style="width:200px">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let a of filtered()">
          <td style="font-weight:600">{{ a.accountNumber }}</td>
          <td>{{ typeLabel(a.accountType) }}</td>
          <td>{{ a.initialBalance | number:'1.2-2' }}</td>
          <td>
            <span class="badge" [class.ok]="a.active" [class.off]="!a.active">
              {{ a.active ? 'Activa' : 'Inactiva' }}
            </span>
          </td>
          <td>{{ a.client?.fullName || '—' }}</td>
          <td>
            <div class="actions-inline">
              <button class="btn secondary nowrap" (click)="edit(a)">Editar</button>
              <button class="btn danger nowrap" (click)="remove(a)">Eliminar</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <ng-template #emptyState>
    <div class="muted">No hay cuentas.</div>
  </ng-template>
</div>